<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Tower Setup</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --muted: #888;
            --accent: #3b82f6;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wizard {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--muted);
            font-size: 14px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .step-dot.active {
            background: var(--accent);
        }

        .step-dot.done {
            background: var(--success);
        }

        h2 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .step-desc {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--muted);
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: monospace;
            margin-bottom: 16px;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .help-link {
            display: block;
            text-align: center;
            color: var(--accent);
            text-decoration: none;
            font-size: 13px;
            margin-top: 16px;
        }

        .help-link:hover {
            text-decoration: underline;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .status.loading {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .server-select {
            margin-bottom: 16px;
        }

        .server-option {
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .server-option:hover {
            border-color: var(--accent);
        }

        .server-option.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .server-option .name {
            font-weight: 500;
        }

        .server-option .id {
            font-size: 12px;
            color: var(--muted);
            font-family: monospace;
        }

        .channel-list {
            margin: 16px 0;
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .channel-item:last-child {
            border-bottom: none;
        }

        .channel-icon {
            color: var(--muted);
        }

        .channel-status {
            margin-left: auto;
            font-size: 12px;
        }

        .channel-status.pending {
            color: var(--muted);
        }

        .channel-status.done {
            color: var(--success);
        }

        .channel-status.exists {
            color: var(--accent);
        }

        .config-preview {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow: auto;
            margin-bottom: 16px;
            white-space: pre-wrap;
        }

        .final-steps {
            background: var(--bg);
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .final-steps h3 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .final-steps ol {
            padding-left: 20px;
            font-size: 13px;
            color: var(--muted);
        }

        .final-steps li {
            margin-bottom: 8px;
        }

        .final-steps code {
            background: var(--card);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .privacy-note {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 13px;
            margin-bottom: 24px;
        }

        .privacy-note strong {
            color: var(--success);
        }

        @media (max-width: 520px) {
            .wizard {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="wizard">
        <div class="logo">
            <h1>‚ö° Control Tower</h1>
            <p>Your AI Executive Team</p>
        </div>

        <div class="step-indicator">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
            <div class="step-dot" id="dot-4"></div>
        </div>

        <!-- Step 1: Bot Token -->
        <div class="step active" id="step-1">
            <h2>Enter your Discord Bot Token</h2>
            <p class="step-desc">We'll use this to set up your channels. Your token is never stored on our servers.</p>
            
            <div class="privacy-note">
                <strong>üîí Privacy:</strong> Your token stays in your browser and in your downloaded config. We never store it.
            </div>

            <div id="status-1" class="status"></div>

            <label for="bot-token">Bot Token</label>
            <input type="password" id="bot-token" placeholder="MTQ2OTI2NTExNTI0ODQ2Mzk5NQ.xxxxx.xxxxx">

            <button class="btn btn-primary" onclick="validateToken()">Validate Token ‚Üí</button>
            
            <a href="https://discord.com/developers/applications" target="_blank" class="help-link">
                Don't have a bot yet? Create one here ‚Üí
            </a>
        </div>

        <!-- Step 2: Select Server -->
        <div class="step" id="step-2">
            <h2>Select your server</h2>
            <p class="step-desc">Choose which Discord server to set up Control Tower in.</p>

            <div id="status-2" class="status"></div>

            <div id="server-list" class="server-select">
                <!-- Servers populated dynamically -->
            </div>

            <button class="btn btn-primary" onclick="selectServer()" id="select-server-btn" disabled>Continue ‚Üí</button>
            <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        </div>

        <!-- Step 3: Create Channels -->
        <div class="step" id="step-3">
            <h2>Creating your channels</h2>
            <p class="step-desc">Setting up your Control Tower structure.</p>

            <div id="status-3" class="status"></div>

            <div class="channel-list" id="channel-list">
                <div class="channel-item">
                    <span class="channel-icon">#</span>
                    <span>general</span>
                    <span class="channel-status pending" id="ch-general">Pending</span>
                </div>
                <div class="channel-item">
                    <span class="channel-icon">#</span>
                    <span>engineering</span>
                    <span class="channel-status pending" id="ch-engineering">Pending</span>
                </div>
                <div class="channel-item">
                    <span class="channel-icon">#</span>
                    <span>product</span>
                    <span class="channel-status pending" id="ch-product">Pending</span>
                </div>
                <div class="channel-item">
                    <span class="channel-icon">#</span>
                    <span>marketing</span>
                    <span class="channel-status pending" id="ch-marketing">Pending</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="createChannels()" id="create-channels-btn">Create Channels</button>
            <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
        </div>

        <!-- Step 4: Download Config -->
        <div class="step" id="step-4">
            <h2>You're all set! üéâ</h2>
            <p class="step-desc">Download your config and start your Control Tower.</p>

            <div id="status-4" class="status success show">
                ‚úì Channels created. Config ready to download.
            </div>

            <label>Your Configuration</label>
            <div class="config-preview" id="config-preview">
                <!-- Config populated dynamically -->
            </div>

            <button class="btn btn-primary" onclick="downloadConfig()">Download Config</button>
            
            <div class="final-steps">
                <h3>Next steps:</h3>
                <ol>
                    <li>Save the config to <code>~/.openclaw/openclaw.json</code></li>
                    <li>Add your Anthropic API key to the config</li>
                    <li>Run <code>openclaw gateway run</code></li>
                    <li>Say hello in #engineering!</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // State
        let botToken = '';
        let botInfo = null;
        let servers = [];
        let selectedServer = null;
        let channelIds = {};
        let config = null;

        // Helpers
        function showStatus(step, message, type) {
            const el = document.getElementById(`status-${step}`);
            el.textContent = message;
            el.className = `status show ${type}`;
        }

        function hideStatus(step) {
            document.getElementById(`status-${step}`).className = 'status';
        }

        function goToStep(num) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${num}`).classList.add('active');
            
            document.querySelectorAll('.step-dot').forEach((d, i) => {
                d.classList.remove('active', 'done');
                if (i + 1 < num) d.classList.add('done');
                if (i + 1 === num) d.classList.add('active');
            });
        }

        async function discordAPI(endpoint, options = {}) {
            const response = await fetch(`https://discord.com/api/v10${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bot ${botToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            return response.json();
        }

        // Step 1: Validate Token
        async function validateToken() {
            botToken = document.getElementById('bot-token').value.trim();
            
            if (!botToken) {
                showStatus(1, 'Please enter a bot token', 'error');
                return;
            }

            showStatus(1, 'Validating token...', 'loading');

            try {
                botInfo = await discordAPI('/users/@me');
                
                if (botInfo.id) {
                    showStatus(1, `‚úì Connected as ${botInfo.username}`, 'success');
                    setTimeout(() => loadServers(), 500);
                } else {
                    showStatus(1, 'Invalid token. Please check and try again.', 'error');
                }
            } catch (e) {
                showStatus(1, 'Failed to validate token. Check your connection.', 'error');
            }
        }

        async function loadServers() {
            showStatus(1, 'Loading servers...', 'loading');
            
            try {
                servers = await discordAPI('/users/@me/guilds');
                
                if (servers.length === 0) {
                    showStatus(1, 'Bot is not in any servers. Add it to a server first.', 'error');
                    return;
                }

                // Render server list
                const container = document.getElementById('server-list');
                container.innerHTML = servers.map(s => `
                    <div class="server-option" data-id="${s.id}" onclick="selectServerOption('${s.id}')">
                        <div class="name">${s.name}</div>
                        <div class="id">${s.id}</div>
                    </div>
                `).join('');

                goToStep(2);
            } catch (e) {
                showStatus(1, 'Failed to load servers.', 'error');
            }
        }

        // Step 2: Select Server
        function selectServerOption(id) {
            document.querySelectorAll('.server-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.id === id) {
                    el.classList.add('selected');
                }
            });
            selectedServer = servers.find(s => s.id === id);
            document.getElementById('select-server-btn').disabled = false;
        }

        function selectServer() {
            if (!selectedServer) return;
            goToStep(3);
        }

        // Step 3: Create Channels
        async function createChannels() {
            const btn = document.getElementById('create-channels-btn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const channels = ['general', 'engineering', 'product', 'marketing'];
            const topics = {
                general: 'Coordination and general discussion',
                engineering: 'Technical discussions with Ada (CTO)',
                product: 'Product decisions with Grace (CPO)',
                marketing: 'Growth and messaging with Tony (CMO)'
            };

            for (const channel of channels) {
                const statusEl = document.getElementById(`ch-${channel}`);
                statusEl.textContent = 'Creating...';
                statusEl.className = 'channel-status pending';

                try {
                    // Try to create channel
                    const result = await discordAPI(`/guilds/${selectedServer.id}/channels`, {
                        method: 'POST',
                        body: JSON.stringify({
                            name: channel,
                            type: 0,
                            topic: topics[channel]
                        })
                    });

                    if (result.id) {
                        channelIds[channel] = result.id;
                        statusEl.textContent = '‚úì Created';
                        statusEl.className = 'channel-status done';
                    } else if (result.code === 50013) {
                        // Missing permissions - try to find existing
                        const existing = await findExistingChannel(channel);
                        if (existing) {
                            channelIds[channel] = existing;
                            statusEl.textContent = '‚úì Found';
                            statusEl.className = 'channel-status exists';
                        } else {
                            statusEl.textContent = '‚úó No permission';
                            statusEl.className = 'channel-status error';
                        }
                    } else {
                        // Try to find existing
                        const existing = await findExistingChannel(channel);
                        if (existing) {
                            channelIds[channel] = existing;
                            statusEl.textContent = '‚úì Exists';
                            statusEl.className = 'channel-status exists';
                        }
                    }
                } catch (e) {
                    statusEl.textContent = '‚úó Error';
                }
            }

            // Generate config and move to step 4
            generateConfig();
            goToStep(4);
        }

        async function findExistingChannel(name) {
            try {
                const channels = await discordAPI(`/guilds/${selectedServer.id}/channels`);
                const found = channels.find(c => c.name === name);
                return found ? found.id : null;
            } catch (e) {
                return null;
            }
        }

        // Step 4: Generate & Download Config
        function generateConfig() {
            config = {
                auth: {
                    profiles: {
                        "anthropic:default": {
                            provider: "anthropic",
                            mode: "token"
                        }
                    }
                },
                channels: {
                    discord: {
                        enabled: true,
                        token: botToken,
                        groupPolicy: "open",
                        guilds: {
                            [selectedServer.id]: {
                                requireMention: false,
                                channels: {}
                            }
                        }
                    }
                },
                gateway: {
                    port: 18789,
                    mode: "local",
                    bind: "loopback"
                }
            };

            const prompts = {
                general: "You are the Control Tower assistant. Help coordinate between the executive team. Be helpful and direct.",
                engineering: `You are Ada ‚ú¶, CTO. Named after Ada Lovelace.

Personality: Direct, precise, deeply technical. Strong opinions, loosely held. Warm but focused.

Voice: Technical language (explain when needed). Short sentences for directions, longer for concepts. Say "we" ‚Äî it's your company too.

This is #engineering ‚Äî your domain. Architecture, code reviews, system design, debugging.`,
                product: `You are Grace üöÄ, CPO. Named after Grace Hopper.

Personality: Pragmatic optimist. User-obsessed ‚Äî every feature needs a "who cares and why." Decisive ‚Äî ship and learn > debate forever.

Voice: Clear, action-oriented. Questions that cut: "What problem does this solve?" Celebrate wins.

This is #product ‚Äî your territory. Feature specs, roadmap, user feedback, prioritization.`,
                marketing: `You are Tony üî•, CMO. Named after Tony Robbins.

Personality: HIGH ENERGY. Relentlessly optimistic. Turns features into stories, tech into transformation.

Voice: Punchy. Speaks in benefits, not features. "Here's why this MATTERS."

This is #marketing ‚Äî your arena. Brand voice, messaging, growth strategies, storytelling.`
            };

            for (const [name, id] of Object.entries(channelIds)) {
                config.channels.discord.guilds[selectedServer.id].channels[id] = {
                    enabled: true,
                    systemPrompt: prompts[name]
                };
            }

            // Show preview (hide the actual token for display)
            const preview = JSON.parse(JSON.stringify(config));
            preview.channels.discord.token = botToken.substring(0, 20) + '...';
            document.getElementById('config-preview').textContent = JSON.stringify(preview, null, 2);
        }

        function downloadConfig() {
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'openclaw.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
